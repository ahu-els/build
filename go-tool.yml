doc: 'Build file for Go tools'
default: test

extends:
- c4s4/build/buildir.yml
- c4s4/build/changelog.yml
- c4s4/build/go-libs.yml

properties:
  NAME:    '#{filename(_BASE)}'
  ARCHIVE: '#{BUILD_DIR}/#{NAME}-#{VERSION}.tar.gz'

targets:

  test:
    doc: Run Go tests
    steps:
    - 'go test'

  run:
    doc: Run Goo tool
    steps:
    - 'go run "#{NAME}.go"'

  bin:
    doc: Build Go tool
    steps:
    - mkdir: '#{BUILD_DIR}'
    - 'go build -o #{BUILD_DIR}/#{NAME}'

  archive:
    doc: Build distribution archive
    steps:
    - mkdir: '#{BUILD_DIR}/#{NAME}-#{VERSION}/bin/'
    - 'gox -output=#{BUILD_DIR}/#{NAME}-#{VERSION}/bin/{{.Dir}}_{{.OS}}_{{.Arch}}'
    - copy:
      - 'README.md'
      - 'CHANGELOG.yml'
      - 'LICENSE.txt'
      todir: '#{BUILD_DIR}/#{NAME}-#{VERSION}'
    - tar:    '#{NAME}-#{VERSION}/**/*'
      dir:    '#{BUILD_DIR}'
      tofile: '#{ARCHIVE}'

  release:
    doc: Perform a release
    depends: [clean, test, archive]
    steps:
    - super:
