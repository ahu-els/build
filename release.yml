doc: 'Parent build file for changelog'

properties:
  VERSION:        '#{run("changelog", "release", "version")}'
  DEVELOP_BRANCH: 'develop'

targets:

  release:
    doc: 'Perform a release'
    steps:
    # check uncommitted changes
    - try:
      - $: 'git diff --quiet --exit-code HEAD'
      catch:
      - throw: 'There are uncommitted changes'
    # check we are on branch develop
    - $: 'git rev-parse --abbrev-ref HEAD'
      =: 'branch'
    - if: 'branch != DEVELOP_BRANCH'
      then:
      - throw: 'We are not on branch "#{DEVELOP_BRANCH}"'
    # check release date is today
    - try:
      - $: 'changelog release date check'
      catch:
      - throw: 'bad release date in changelog'
    # read changelog information
    - try:
      - |
        message = run("changelog", "release", "summary")
        if message == "" {
          message = "Release " + VERSION
        } else {
          message = "Release " + VERSION + ": " + message
        }
      catch:
      - throw: 'reading changelog information'
    # print information message
    - print: 'Releasing version "#{VERSION}" with message "#{message}"'
    # merge develop on master tag release and return on develop
    - try:
      - $: 'git checkout master'
      - $: 'git pull'
      - $: 'git merge --no-ff develop -m "#{message}"'
      - $: 'git push'
      - $: 'git tag -a "#{VERSION}" -m "#{message}"'
      - $: 'git push origin "#{VERSION}"'
      catch:
      - throw: 'performing release'
      finally:
      - $: 'git checkout develop'

  delete-release:
    doc: Delete release by deleting local and remote tags
    steps:
    - prompt:  'WARNING! You are about to delete local and remote "#{VERSION}" tag. Do you confirm?'
      to:      'confirm'
      default: 'n'
      pattern: '^[yn]$'
      error:   'You must answer y or n'
    - if: 'confirm == "y"'
      then:
      - $: 'git tag -d #{VERSION}'
      - $: 'git push origin :refs/tags/#{VERSION}'
      else:
      - print: 'Aborting'
