# NeON Build File (http://github.com/c4s4/neon)

doc: Parent build file for Github

properties:
  GIT_USERNAME: ~
  GIT_API:      'https://api.github.com'
  GIT_UPLOAD:   'https://uploads.github.com'

configuration:
# configuration file for Github with GIT_USERNAME
- ~/.github.yml

targets:

  downloads:
    doc: Print archive downloads
    steps:
    - print: 'Downloads for ={NAME}:'
    - request: '={GIT_API}/repos/={GIT_USERNAME}/={NAME}/releases'
    - for: release
      in:  =jsondecode(_body)
      do:
      - 'tag = release["tag_name"]'
      - 'downloads = release["assets"][0]["download_count"]'
      - print: '={tag}: ={downloads}'

  upload:
    doc: Upload archive for release
    steps:
    - request: '={GIT_API}/repos/={GIT_USERNAME}/={NAME}/releases/tags/={VERSION}'
    - 'release = jsondecode(_body)'
    - 'id = toInt(release["id"])'
    - print: '={release["upload_url"]}'
    - print: 'Release ={VERSION} found'
    - 'url = GIT_UPLOAD+"/repos/"+GIT_USERNAME+"/"+NAME+"/releases/"+id+"/assets?name="+ARCHIVE'
    - print: =url
    - request:  =url
      method:   POST
      headers:  {'Content-Type': 'application/gzip'}
      file:     =ARCHIVE
      username: =GIT_USERNAME
      password: =GIT_PASSWORD
