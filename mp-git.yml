# NeON Build File (http://github.com/c4s4/neon)

doc: Parent build file for mieuxplacer git stuff

properties:
  RDB_BRANCH:    'RDB-'
  MASTER_BRANCH: 'master'

targets:

  _check-uncommitted-changes:
    doc: Check uncommitted changes
    steps:
    - try:
      - $: ['git', 'diff', '--quiet', '--exit-code', 'HEAD']
      - print: 'There are no uncommitted changes'
      catch:
      - throw: 'There are uncommitted changes'

  _check-rdb-branch:
    doc: Check that we are on branch named RDB-XXX
    steps:
    - $:  ['git', 'rev-parse', '--abbrev-ref', 'HEAD']
      3=: 'branch'
    - if: 'branch[0:len(RDB_BRANCH)] != RDB_BRANCH'
      then:
      - throw: "We are not on RDB branch"
      else:
      - print: 'We are on RDB branch' 
 
  rdb-open:
    doc: Create a RDB branch
    steps:
    - call: _check-uncommitted-changes
    - call: _check-rdb-branch
    - prompt:  'RDB number'
      to:      'rdb'
      pattern: '^\d+$'
      error:   'A RDB number must be made of digits'
    - 'rdbbranch = "RDB-" + rdb'
    - $: ['git', 'checkout', '-b', =rdbbranch]
    - $: ['git', 'push', '-u', 'origin', =rdbbranch]
    - print: "RDB branch '={rdbbranch}' created"

  rdb-rebase:
    doc: Rebase a RDB branch
    steps:
    - call: _check-uncommitted-changes
    - call: _check-rdb-branch
    - $:  ['git', 'rebase', =MASTER_BRANCH]
    - print: "RDB branch '={branch}' rebased with ={MASTER_BRANCH}"
